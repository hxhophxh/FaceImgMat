# FaceImgMat 离线一键部署 — 操作指南（精简）

本指南基于脚本 `super-offline-deployment/一键完整部署.bat`，提供在 Windows 环境下的离线化、自动化部署步骤与注意事项。

## 适用场景
- 无法稳定访问外网或企业内网隔离环境
- 需要一键化完成 Python 安装、依赖安装、模型拷贝与服务启动

## 前置条件
- 操作系统：Windows 10/11 64 位
- 权限：建议使用具备软件安装与写入权限的账户
- 磁盘空间：建议预留数 GB（含依赖与模型）
- 网络（可选）：
  - 若本地不存在 `offline_bundle.zip`，脚本会尝试从 GitHub 下载最新离线包。
  - 如访问 GitHub 较慢，请耐心等待或多次重试；也可提前手工下载后放置到 `super-offline-deployment/`。

## 一键部署步骤
脚本路径：`super-offline-deployment/一键完整部署.bat`

双击运行，按提示选择开始步骤（默认从 0 开始）。

- 步骤 0 准备离线包
  - 检查 `offline_bundle.zip` 是否存在；如缺失将尝试从 GitHub 下载（可能较慢）。
  - 自动解压至 `super-offline-deployment/offline_bundle/`。解压失败会自动删除并重试下载。

- 步骤 1 检查/安装 Python 3.12
  - 自动搜索常见路径或 `python --version`。
  - 若未检测到，将使用离线安装器（`offline_bundle/python/python-3.12.7-amd64.exe`）静默安装，默认目录优先 `D:\\Python312`，否则安装至系统盘。

- 步骤 2 准备项目目录
  - 进入 `offline_bundle/FaceImgMat`，清理旧 `.venv`；同步 `requirements.lock`。

- 步骤 3 创建虚拟环境
  - 使用检测/安装好的 Python 3.12 创建 `.venv`。

- 步骤 4 安装依赖
  - 优先使用 `offline_bundle/wheels/` 离线安装：`pip --no-index --find-links ... -r requirements.lock`。
  - 如失败，回退为同步 `offline_bundle/site-packages/` 到虚拟环境目录。
  - 校验关键依赖（如 Flask）是否正确安装，否则终止并提示。

- 步骤 5 拷贝模型文件
  - 将 `offline_bundle/models/insightface_models/` 同步到项目 `models/insightface_models/`。

- 步骤 6 部署完成 & 创建快捷方式
  - 在桌面创建“FaceImgMat.lnk”，目标：`offline_bundle/FaceImgMat/start.bat`。

- 步骤 7 启动服务并打开浏览器
  - 调用 `start.bat` 启动服务，约 6 秒后自动打开 `http://127.0.0.1:5000`。

提示：脚本允许从任意步骤重试。例如仅需重新安装依赖，可从步骤 4 重新开始。

## 常见问题与处理
- GitHub 下载慢/失败：
  - 多次重试或耐心等待；或提前把 `offline_bundle.zip` 放置到 `super-offline-deployment/`。
  - 如 ZIP 损坏，脚本会删除并重新下载。
- Python 未安装或版本不匹配：
  - 脚本会自动安装 3.12；或手动运行 `01-Python安装包/python-3.12.7-amd64.exe`，再从步骤 2/3 继续。
- 依赖安装失败：
  - 确保 `offline_bundle/wheels/` 与 `offline_bundle/site-packages/` 完整；从步骤 4 重试。
- 模型缺失：
  - 确认 `offline_bundle/models/insightface_models/` 存在并可访问；从步骤 5 重试。
- 端口 5000 被占用：
  - 结束占用该端口的程序后重试；或在高级场景中调整服务端口。

## 目录与文件说明（关键）
- `super-offline-deployment/offline_bundle/`：解压后的离线包根目录
  - `FaceImgMat/`：项目代码与启动脚本（`start.bat`/`start.ps1`/`start.sh`）
  - `models/insightface_models/`：人脸识别模型
  - `python/`：Python 安装器（3.12 x64）
  - `site-packages/` 与 `wheels/`：离线依赖来源

## 运行与维护
- 启动：推荐使用桌面快捷方式“FaceImgMat.lnk”，或直接运行 `FaceImgMat/start.bat`。
- 日志：`logs/`
- 数据库：`instance/face_matching.db`
- 升级：备份 `instance/` 与 `logs/`，替换新离线包后从需要的步骤重试即可。
- 卸载/清理：可运行 `super-offline-deployment/卸载清理.bat`，或手动删除生成目录与快捷方式。

## 安全提示
- 建议在可信内网使用，避免对公网直接暴露服务。
- 涉及人脸数据的处理须遵守相关法律法规与企业合规要求。

—
如需更细粒度的参数与脚本逻辑说明，请参考 `docs` 目录中的详细部署文档与源码注释。